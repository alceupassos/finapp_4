# Cursor Rules - FinApp Dashboard

## üö® REGRAS CR√çTICAS IMUT√ÅVEIS

> **LEIA PRIMEIRO**: Estas regras s√£o fundamentais e N√ÉO devem ser violadas. Consulte `REGRAS_PROJETO.md` para detalhes completos.

### 1. Tokens F360 NUNCA v√£o no `.env.local`
- **CR√çTICO**: Tokens F360 s√£o espec√≠ficos por empresa e devem estar APENAS na tabela `companies.token_f360`
- **O que vai no `.env.local`**: Apenas vari√°veis do Supabase (`VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`, `VITE_ENABLE_ADMIN`)
- **NUNCA colocar**: `F360_TOKEN`, `F360_CNPJ`, `F360_WEBHOOK_*`, `VOLPE_TOKEN_*`
- **Como usar**: Sempre buscar token do banco: `SELECT token_f360 FROM companies WHERE cnpj = ?`

### 2. Empresas s√£o associadas via `user_companies`
- **CR√çTICO**: A tabela `user_companies` √© a √∫nica fonte de verdade para acesso do usu√°rio
- **NUNCA**: Assumir que todas as empresas est√£o dispon√≠veis, filtrar por token F360, usar `client_id` para acesso
- **SEMPRE**: Buscar empresas do usu√°rio logado via `user_companies`, verificar `user_id` antes de buscar empresas
- **Fluxo**: Login ‚Üí obter `user_id` ‚Üí buscar em `user_companies` ‚Üí mostrar apenas empresas encontradas

### 3. Estrutura de Tabelas
- **`companies`**: Armazena empresas com `token_f360` (n√£o no .env)
- **`user_companies`**: Controla acesso (user_id ‚Üí company_cnpj)
- **`clients`**: Agrupa empresas relacionadas (n√£o controla acesso)
- **Dados financeiros**: Sempre incluir `company_cnpj` e `company_id`

### 4. Importa√ß√£o de Empresas
- **SEMPRE**: Criar registro em `user_companies` ao criar/importar empresa
- **SEMPRE**: Salvar `token_f360` na tabela `companies` (nunca no .env)
- **NUNCA**: Pular dados inv√°lidos - sempre tentar corrigir e importar

---

## Regras de Filtros e Contexto

### 1. SEMPRE Respeitar Filtros da P√°gina
- **CR√çTICO**: Todos os componentes, gr√°ficos, tabelas e fun√ß√µes devem SEMPRE respeitar os filtros selecionados pelo usu√°rio na p√°gina
- Filtros incluem: per√≠odo (Ano/M√™s), ano, trimestre, m√™s, categoria, conta banc√°ria, empresas selecionadas
- NUNCA ignorar ou sobrescrever filtros do usu√°rio
- Quando criar novos componentes, SEMPRE aceitar e aplicar filtros como props
- Quando buscar dados, SEMPRE usar os filtros fornecidos nas queries

### 2. Filtros Globais vs Locais
- Filtros globais v√™m de `App.tsx` (selectedCompanies, period, selectedMonth)
- Filtros locais v√™m de componentes espec√≠ficos (HorizontalFilters, etc)
- Componentes devem aceitar ambos e aplicar a interse√ß√£o dos filtros
- Prioridade: filtros locais espec√≠ficos > filtros globais

### 3. Bot√£o de Reset de Filtros
- Sempre incluir um bot√£o discreto para resetar filtros aos valores padr√£o
- Bot√£o deve ser vis√≠vel mas n√£o intrusivo (√≠cone pequeno, posi√ß√£o discreta)
- Reset deve voltar para: Ano atual, per√≠odo "Ano", todos os meses/trimestres/categorias

### 4. Empresas e Grupos
- NUNCA filtrar por "Grupo Volpe" ou qualquer grupo espec√≠fico hardcoded
- Usar apenas empresas associadas ao usu√°rio logado via `user_companies`
- N√£o assumir grupo empresarial espec√≠fico - usar dados do banco
- Remover todos os fallbacks hardcoded com "Grupo Volpe"

### 5. Dados e Queries
- Todas as queries devem usar filtros de per√≠odo, empresa e categoria quando aplic√°vel
- N√£o retornar dados fora do per√≠odo selecionado
- N√£o retornar dados de empresas n√£o selecionadas
- Consolidar dados apenas das empresas selecionadas
- **CR√çTICO**: `getDRE()` e `getDFC()` devem aceitar par√¢metros `year` e `month` para filtrar por per√≠odo
- **CR√çTICO**: Usar tabela `dfc_entries` (N√ÉO `cashflow_entries`) para dados de fluxo de caixa
- **CR√çTICO**: Filtros de per√≠odo devem ser aplicados na query, n√£o apenas no frontend

### 6. Componentes de Gr√°ficos
- Todos os gr√°ficos devem aceitar props de filtros (cnpj, year, month, etc)
- Aplicar filtros antes de renderizar dados
- Mostrar indicador visual quando filtros est√£o ativos
- Atualizar automaticamente quando filtros mudam

### 7. Performance
- Cachear dados apenas quando filtros s√£o os mesmos
- Invalidar cache quando filtros mudam
- N√£o fazer queries desnecess√°rias com filtros diferentes

### 8. Consolida√ß√£o de M√∫ltiplas Empresas
- **CR√çTICO**: Quando m√∫ltiplas empresas s√£o selecionadas, SOMAR valores, n√£o concatenar registros
- Usar Map/Reduce para consolidar dados por chave √∫nica (data + conta + natureza)
- Validar que soma individual = total consolidado
- N√£o duplicar registros na consolida√ß√£o

### 9. Valida√ß√£o de Dados Importados
- **SEMPRE**: Executar testes de integridade ap√≥s importa√ß√£o
- Verificar aus√™ncia de duplicatas (usar constraints √∫nicas)
- Validar totais: receitas - despesas = resultado (DRE)
- Validar totais: entradas - sa√≠das = varia√ß√£o caixa (DFC)
- Scripts de teste: `scripts/tests/test_*.mjs`

## Exemplos de Implementa√ß√£o

### Componente com Filtros
```typescript
interface MyComponentProps {
  selectedCompanies: string[]
  selectedYear: string
  selectedMonth?: string
  // ... outros filtros
}

export function MyComponent({ selectedCompanies, selectedYear, selectedMonth }: MyComponentProps) {
  // SEMPRE usar os filtros fornecidos
  const data = useMemo(() => {
    return fetchData(selectedCompanies, selectedYear, selectedMonth)
  }, [selectedCompanies, selectedYear, selectedMonth])
  
  // ...
}
```

### Query com Filtros
```typescript
const query = {
  company_cnpj: `in.(${selectedCompanies.join(',')})`,
  year: `eq.${selectedYear}`,
  ...(selectedMonth && { month: `eq.${selectedMonth}` })
}
```

### Bot√£o Reset
```typescript
<button
  onClick={() => {
    onYearChange(new Date().getFullYear().toString())
    onMonthChange('')
    onQuarterChange('')
    onCategoryChange('')
  }}
  className="text-xs text-muted-foreground hover:text-foreground"
  title="Limpar filtros"
>
  <X className="w-3 h-3" />
</button>
```

---

# üìö √çNDICE INCREMENTAL DO PROJETO

> **Uso**: Consultar este √≠ndice antes de ler arquivos completos. Atualizar incrementalmente ap√≥s mudan√ßas significativas.

## üîç QUICK REFERENCE - Arquivos Principais

| Caminho | Fun√ß√£o | √öltima Atualiza√ß√£o |
|---------|--------|-------------------|
| `src/App.tsx` | Componente raiz, roteamento, filtros globais | 2025-01 |
| `src/components/ReportsPage.tsx` | P√°gina principal de relat√≥rios com sidebar | 2025-01 |
| `src/components/reports/ReportsSidebar.tsx` | Menu lateral retr√°til de se√ß√µes | 2025-01 |
| `src/components/reports/DRESection.tsx` | Se√ß√£o DRE com KPIs e gr√°ficos | 2025-01 |
| `src/components/reports/DFCSection.tsx` | Se√ß√£o DFC (fluxo de caixa) | 2025-01 |
| `src/components/reports/BanksSection.tsx` | Se√ß√£o de contas banc√°rias | 2025-01 |
| `src/components/reports/ReconciliationSection.tsx` | Concilia√ß√£o banc√°ria | 2025-01 |
| `src/services/f360Service.ts` | Cliente TypeScript API F360 | 2025-01 |
| `src/services/f360ImportService.ts` | Servi√ßo unificado importa√ß√£o F360 (SINGLE/GROUP) | 2025-01 |
| `src/services/supabaseRest.ts` | Cliente REST Supabase, queries | 2025-01 |
| `supabase/functions/sync-f360/index.ts` | Edge Function sincroniza√ß√£o F360 | 2025-01 |
| `supabase/functions/f360-discover/index.ts` | Edge Function descobrir empresas F360 | 2025-01 |
| `scripts/import_volpe_complete.mjs` | Importa√ß√£o completa Grupo Volpe | 2025-01 |
| `scripts/tests/test_f360_*.mjs` | Bateria de testes F360 | 2025-01 |
| `src/services/auth.ts` | Autentica√ß√£o Supabase | 2025-01 |
| `scripts/import_volpe_f360.mjs` | Importa√ß√£o dados 13 empresas Volpe | 2025-01 |
| `scripts/register_volpe_companies.mjs` | Cadastro empresas no Supabase | 2025-01 |
| `supabase/migrations/create_f360_volpe_tables.sql` | Tabelas DRE/DFC/Bancos | 2025-01 |

## üîê CREDENCIAIS E CONFIGURA√á√ïES

### F360 Finan√ßas
- **Base URL**: `https://financas.f360.com.br`
- **Token Grupo Volpe**: `eb0e1ef3-516c-4e4a-a043-5b1e45794f42` (atualizado 2025-01)
- **Login**: `volpe.matriz@ifinance.com.br`
- **Senha**: `v3T$cABl5.`
- **Endpoints principais**:
  - Login: `POST /PublicLoginAPI/DoLogin`
  - Plano Contas: `GET /PlanoDeContasPublicAPI/ListarPlanosContas`
  - Contas Banc√°rias: `GET /ContaBancariaPublicAPI/ListarContasBancarias`
  - Parcelas T√≠tulos: `GET /ParcelasDeTituloPublicAPI/ListarParcelasDeTitulos`
  - Relat√≥rios: `POST /PublicRelatorioAPI/GerarRelatorio`
  - Download Relat√≥rio: `GET /PublicRelatorioAPI/Download?id={relatorioId}`

### Supabase
- **Vari√°veis**: `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`
- **Tabelas principais**: `companies`, `dre_entries`, `dfc_entries`, `bank_accounts`, `bank_transactions`, `reconciliation_items`, `user_companies`, `accounting_entries`, `chart_of_accounts`

### Grupo Volpe - 13 Empresas
| CNPJ | Nome |
|------|------|
| 26888098000159 | VOLPE MATRIZ |
| 26888098000230 | VOLPE ZOIAO |
| 26888098000310 | VOLPE MAU√Å |
| 26888098000400 | VOLPE DIADEMA |
| 26888098000582 | VOLPE GRAJA√ö |
| 26888098000663 | VOLPE SANTO ANDR√â |
| 26888098000744 | VOLPE CAMPO LIMPO |
| 26888098000825 | VOLPE BRASIL√ÇNDIA |
| 26888098000906 | VOLPE PO√Å |
| 26888098001040 | VOLPE ITAIM |
| 26888098001120 | VOLPE PRAIA GRANDE |
| 26888098001201 | VOLPE ITANHA√âM |
| 26888098001392 | VOLPE S√ÉO MATHEUS |

## üèóÔ∏è ARQUITETURA

### Stack Principal
- **Frontend**: React 18 + TypeScript + Vite
- **UI**: TailwindCSS + Radix UI + Framer Motion
- **Gr√°ficos**: Recharts + Tremor
- **Backend**: Supabase (PostgreSQL + Auth + Storage)
- **Integra√ß√£o**: F360 API (REST + Webhooks)

### Padr√µes de C√≥digo
- **Componentes**: Functional Components com hooks
- **Estado**: useState/useEffect, Zustand para global
- **Queries**: Supabase REST API via `supabaseRest.ts`
- **Anima√ß√µes**: Framer Motion (entrada escalonada, hover effects)
- **Filtros**: Props drilling de App.tsx ‚Üí componentes filhos
- **Estilo**: Classes Tailwind + `card-premium` para cards

### Estrutura de Pastas
```
src/
‚îú‚îÄ‚îÄ components/        # Componentes React
‚îÇ   ‚îú‚îÄ‚îÄ reports/      # Se√ß√µes de relat√≥rios
‚îÇ   ‚îú‚îÄ‚îÄ charts/       # Gr√°ficos Recharts
‚îÇ   ‚îî‚îÄ‚îÄ ui/           # Componentes base Radix
‚îú‚îÄ‚îÄ services/         # Clientes API, l√≥gica de neg√≥cio
‚îú‚îÄ‚îÄ hooks/            # Custom hooks
‚îú‚îÄ‚îÄ types/            # TypeScript types
‚îî‚îÄ‚îÄ lib/              # Utilit√°rios

scripts/              # Scripts Node.js (importa√ß√£o, migra√ß√µes)
supabase/migrations/  # Migra√ß√µes SQL
```

## üõ†Ô∏è COMANDOS √öTEIS

### Desenvolvimento
```bash
npm run dev              # Iniciar dev server
npm run build            # Build produ√ß√£o
npm run lint             # Verificar TypeScript
npm run preview          # Preview build
```

### Importa√ß√£o de Dados
```bash
# Importar 13 empresas Volpe do F360 (completo)
node scripts/import_volpe_complete.mjs

# Importar 13 empresas Volpe do F360 (m√©todo antigo)
node scripts/import_volpe_f360.mjs

# Cadastrar empresas no Supabase
node scripts/register_volpe_companies.mjs

# Testes F360
node scripts/tests/test_f360_login.mjs
node scripts/tests/test_f360_group.mjs
node scripts/tests/test_f360_single.mjs [token]
node scripts/tests/test_f360_persistence.mjs
```

### Supabase
```bash
# Aplicar migra√ß√µes
supabase migration up

# Configurar secrets
npm run supabase:secrets
```

## üìù CHANGELOG

### 2025-01-XX - Integra√ß√£o Completa F360 com Dados Reais 2025
- ‚úÖ Criado `docs/F360_API_INDEX.md` - √çndice completo da API F360
- ‚úÖ Criado `scripts/import_f360_2025_complete.mjs` - Script de importa√ß√£o 2025
- ‚úÖ Criada suite de testes: `test_data_integrity.mjs`, `test_no_duplicates.mjs`, `test_filter_consistency.mjs`, `test_consolidation.mjs`
- ‚úÖ Atualizado `getDRE()` e `getDFC()` para aceitar filtros de per√≠odo (year, month)
- ‚úÖ Corrigido uso de `dfc_entries` em vez de `cashflow_entries`
- ‚úÖ Implementada consolida√ß√£o correta de m√∫ltiplas empresas (soma de valores)
- ‚úÖ Criado `docs/TESTE_FILTROS_CHECKLIST.md` - Checklist de testes
- ‚úÖ Atualizado cursor rules com regras de valida√ß√£o e consolida√ß√£o

### 2025-01-XX - Sistema Completo Importa√ß√£o F360 (SINGLE/GROUP)
- ‚úÖ Criado `f360ImportService.ts` - servi√ßo unificado com suporte SINGLE e GROUP
- ‚úÖ Criadas Edge Functions: `sync-f360` e `f360-discover`
- ‚úÖ Criada bateria de testes: `test_f360_login`, `test_f360_single`, `test_f360_group`, `test_f360_persistence`
- ‚úÖ Criado `import_volpe_complete.mjs` - importa√ß√£o completa Grupo Volpe
- ‚úÖ Implementada detec√ß√£o autom√°tica de modo (SINGLE/GROUP)
- ‚úÖ Implementado mapeamento de CNPJ para grupos
- ‚úÖ Atualizado token Grupo Volpe: `eb0e1ef3-516c-4e4a-a043-5b1e45794f42`
- ‚úÖ Adicionadas regras de importa√ß√£o F360 no `.cursorrules`

### 2025-01-XX - Importa√ß√£o F360 Grupo Volpe + √Årea Relat√≥rios
- ‚úÖ Criadas tabelas: `dre_entries`, `dfc_entries`, `bank_accounts`, `bank_transactions`, `reconciliation_items`
- ‚úÖ Cadastradas 13 empresas Volpe no Supabase
- ‚úÖ Criado `f360Service.ts` - cliente TypeScript F360
- ‚úÖ Criado `import_volpe_f360.mjs` - script importa√ß√£o
- ‚úÖ Refatorado `ReportsPage.tsx` com sidebar retr√°til
- ‚úÖ Criadas se√ß√µes: DRE, DFC, Bancos, Concilia√ß√£o
- ‚úÖ Componentes: `AnimatedReportCard`, `DREWaterfallChart`, `CashflowSankeyChart`
- ‚úÖ Anima√ß√µes Framer Motion em todos componentes

### Hist√≥rico Anterior
- Sistema base com dashboard, an√°lises, not√≠cias
- Integra√ß√£o Supabase para dados financeiros
- Componentes de gr√°ficos e KPIs
- Autentica√ß√£o e controle de acesso

## ‚ö†Ô∏è TODOs / PEND√äNCIAS

### Alta Prioridade
- [ ] Implementar busca real de dados DFC do Supabase (atualmente mockado)
- [ ] Implementar busca real de contas banc√°rias e transa√ß√µes
- [ ] Completar implementa√ß√£o Sankey chart (requer d3-sankey)
- [ ] Adicionar m√©todo `getDFC()` no `supabaseRest.ts`
- [x] Testar importa√ß√£o completa F360 com dados reais

### M√©dia Prioridade
- [ ] Implementar match autom√°tico de concilia√ß√£o banc√°ria
- [ ] Adicionar exporta√ß√£o Excel para DRE/DFC
- [ ] Criar se√ß√£o "Plano de Contas" completa
- [ ] Adicionar filtros avan√ßados por categoria/centro de custo
- [ ] Implementar cache de queries para performance

### Baixa Prioridade
- [ ] Adicionar testes unit√°rios
- [ ] Documenta√ß√£o de API
- [ ] Otimiza√ß√£o de bundle size
- [ ] PWA support

## üîë KEYWORDS PARA BUSCA R√ÅPIDA

**F360**: `f360Service.ts`, `f360ImportService.ts`, `import_volpe_complete.mjs`, `import_f360_2025_complete.mjs`, `F360Service`, `F360ImportService`, `F360SingleImporter`, `F360GroupImporter`
**API F360**: `docs/F360_API_INDEX.md` - √çndice completo da API F360
**Testes**: `scripts/tests/test_data_integrity.mjs`, `test_no_duplicates.mjs`, `test_filter_consistency.mjs`, `test_consolidation.mjs`
**Filtros**: `TESTE_FILTROS_CHECKLIST.md` - Checklist de testes de filtros
**DRE**: `DRESection.tsx`, `dre_entries`, `DREPivotTable.tsx`
**DFC**: `DFCSection.tsx`, `dfc_entries`, `DFCPivotTable.tsx`
**Bancos**: `BanksSection.tsx`, `bank_accounts`, `bank_transactions`
**Concilia√ß√£o**: `ReconciliationSection.tsx`, `reconciliation_items`
**Filtros**: `HorizontalFilters.tsx`, `App.tsx` (selectedCompanies, period)
**Gr√°ficos**: `charts/`, `Recharts`, `DREWaterfallChart.tsx`
**Anima√ß√µes**: `Framer Motion`, `AnimatedReportCard.tsx`
**Supabase**: `supabaseRest.ts`, `auth.ts`, migrations em `supabase/migrations/`
**Scripts2**: `scripts2/scripts/` - Solu√ß√µes de importa√ß√£o/exporta√ß√£o e troubleshooting

## üì¶ SCRIPTS2 - SOLU√á√ïES DE IMPORTA√á√ÉO/EXPORTA√á√ÉO

> **IMPORTANTE**: Sempre consultar `scripts2/scripts/` ao planejar importa√ß√µes/exporta√ß√µes ou resolver problemas com empresas do Grupo Volpe.

### Arquivos Principais em scripts2/scripts/

| Arquivo | Fun√ß√£o | Quando Usar |
|---------|--------|-------------|
| `import-all-f360.ts` | Importa√ß√£o em massa F360 (batches de 10) | Importar m√∫ltiplas empresas de tokens_f360.json |
| `populate-companies.ts` | Popular empresas via API F360 | Cadastrar empresas descobrindo CNPJs via ListarContasBancarias |
| `import-from-excel.ts` | Importar empresas de Excel (unico.xlsx, grupo.xlsx) | Importar empresas com flag is_group correta |
| `import-grupos.ts` | Importar empresas de grupos empresariais | Processar grupos com m√∫ltiplas empresas (ex: VOLPE) |
| `investigate-group-token.ts` | Investigar API de grupos F360 | Descobrir CNPJs de empresas dentro de grupos |
| `find-company-with-data.ts` | Encontrar empresas com dados | Verificar quais empresas t√™m dados importados |
| `check-database-status.ts` | Verificar status do banco | Diagnosticar problemas de dados faltantes |
| `extract-xlsx-schema.ts` | Extrair schema de Excel | Analisar estrutura de arquivos Excel |

### Estrat√©gias de Importa√ß√£o (Baseadas em scripts2/)

#### 1. Extra√ß√£o de CNPJs de Grupos
**Problema**: Token de grupo acessa m√∫ltiplas empresas, precisa descobrir CNPJs individuais.

**Solu√ß√µes (em ordem de prioridade)**:
1. **ListarContasBancarias** (mais confi√°vel para grupos)
   - Endpoint: `GET /ContaBancariaPublicAPI/ListarContasBancarias`
   - Extrai CNPJs do campo `CNPJ` ou `cnpj` das contas
   - Fun√ß√£o: `extractCnpjsFromBankAccounts()` em `populate-companies.ts`

2. **ListarPessoas**
   - Endpoint: `GET /PessoasPublicAPI/ListarPessoas`
   - Extrai CNPJs de clientes/fornecedores
   - Fun√ß√£o: `extractCnpjs()` em `import-grupos.ts`

3. **GerarRelatorioContabil**
   - Endpoint: `POST /PublicRelatorioAPI/GerarRelatorio`
   - Extrai CNPJs do relat√≥rio gerado
   - Fun√ß√£o: `extractCnpjs()` em `investigate-group-token.ts`

#### 2. Processamento de Grupos
**Estrat√©gia**:
- Criar empresa grupo com `is_group = true` e `group_token = token`
- Para cada CNPJ encontrado, criar empresa filha com `parent_company_id = grupo.id`
- Usar mesmo `token_f360` para todas as empresas do grupo

**Arquivo de refer√™ncia**: `import-grupos.ts` linhas 70-277

#### 3. Mapeamento Token -> CNPJ
**Quando usar**: Se CNPJ n√£o pode ser extra√≠do via API.

**Arquivo**: `token-cnpj-mapping.json` (exemplo em `token-cnpj-mapping.example.json`)
```json
{
  "mappings": [
    {
      "token": "uuid-token",
      "cnpj": "12345678000190",
      "companyName": "Nome da Empresa"
    }
  ]
}
```

#### 4. Valida√ß√£o e Troubleshooting
- **Verificar empresas**: `check-database-status.ts`
- **Encontrar empresas com dados**: `find-company-with-data.ts`
- **Investigar problemas**: `investigate-group-token.ts`

### Problemas Comuns e Solu√ß√µes

#### Problema: Empresas do Grupo Volpe n√£o carregam
**Causa**: Token de grupo n√£o extrai CNPJs corretamente.

**Solu√ß√£o**:
1. Usar `ListarContasBancarias` primeiro (mais confi√°vel)
2. Se falhar, tentar `ListarPessoas`
3. Se ainda falhar, usar `GerarRelatorioContabil`
4. Se nenhum funcionar, usar mapeamento manual em `token-cnpj-mapping.json`

**Arquivo de refer√™ncia**: `import-all-f360.ts` linhas 532-787

#### Problema: Dados n√£o aparecem na interface
**Causa**: Empresas criadas mas sem dados financeiros importados.

**Solu√ß√£o**:
1. Verificar se empresas existem: `check-database-status.ts`
2. Verificar se t√™m dados: `find-company-with-data.ts`
3. Importar dados financeiros: `import-all-f360.ts` (importa plano de contas + lan√ßamentos)

#### Problema: Importa√ß√£o muito lenta
**Solu√ß√£o**: 
- Processar em batches (padr√£o: 10 empresas)
- Delay entre batches (padr√£o: 1 segundo)
- Pagina√ß√£o por m√™s para lan√ßamentos (12 meses)

### Padr√µes de C√≥digo (scripts2/)

#### Autentica√ß√£o F360
```typescript
const authResponse = await fetch('https://financas.f360.com.br/PublicLoginAPI/DoLogin', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ token }),
})
const jwt = (await authResponse.json()).Token
```

#### Extra√ß√£o de CNPJs
```typescript
function extractCnpjsFromBankAccounts(bankAccounts: unknown[]): string[] {
  const cnpjs = new Set<string>()
  for (const account of bankAccounts) {
    const acc = account as Record<string, unknown>
    if (acc.CNPJ) {
      const cnpj = String(acc.CNPJ).replace(/\D/g, '')
      if (cnpj.length === 14) cnpjs.add(cnpj)
    }
  }
  return Array.from(cnpjs)
}
```

#### Processamento em Batches
```typescript
const BATCH_SIZE = 10
for (let i = 0; i < tokens.length; i += BATCH_SIZE) {
  const batch = tokens.slice(i, i + BATCH_SIZE)
  await Promise.all(batch.map(token => processCompany(token)))
  await new Promise(resolve => setTimeout(resolve, 1000)) // Delay
}
```

---

## üèõÔ∏è ARQUITETURA: Edge Functions vs MCP vs Scripts Locais

### Decis√µes de Arquitetura (2025-01)

#### Edge Functions (Produ√ß√£o)
**Quando usar**: Opera√ß√µes que precisam ser chamadas do frontend ou via CRON

**Edge Functions existentes:**
- `sync-f360`: Sincroniza√ß√£o F360 (SINGLE/GROUP) - chamada via frontend ou CRON
- `f360-discover`: Descoberta de empresas F360 via ListarContasBancarias

**Caracter√≠sticas:**
- Acesso direto ao banco via Service Role Key
- Retry logic implementado para requisi√ß√µes F360
- Logging detalhado em `import_logs`
- Valida√ß√£o de dados antes de insert
- Tratamento de erros com detalhes

**Padr√£o de uso:**
```typescript
// Chamada do frontend
const response = await fetch(`${supabaseUrl}/functions/v1/sync-f360`, {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${anonKey}`,
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({ cnpj, dataInicio, dataFim }),
})
```

#### MCP Supabase (Opera√ß√µes Administrativas)
**Quando usar**: Queries de leitura, limpeza de dados, migra√ß√µes, valida√ß√µes

**Casos de uso:**
- Verificar status de dados no banco
- Limpar duplicatas e dados lixo
- Criar/alterar constraints e √≠ndices
- Executar testes de integridade
- Aplicar migra√ß√µes SQL

**Padr√£o de uso:**
- Via MCP tools: `mcp_supabase_execute_sql`, `mcp_supabase_apply_migration`
- N√£o usar para opera√ß√µes que precisam ser chamadas do frontend

#### Scripts Locais (Development Only)
**Quando usar**: Importa√ß√£o em massa inicial, debug, troubleshooting, gera√ß√£o de SQL para revis√£o

**Caracter√≠sticas:**
- Executados localmente via Node.js
- Acesso via Service Role Key do `.env.local`
- N√£o devem ser chamados em produ√ß√£o
- √öteis para preparar dados antes de aplicar via Edge Functions

**Exemplos:**
- `scripts/import_f360_2025_mcp.mjs` - Gera SQL para revis√£o antes de aplicar
- `scripts/tests/*.mjs` - Testes de integridade e valida√ß√£o

---

## üîí CONSTRAINTS OBRIGAT√ìRIAS

### Tabelas Financeiras

**dre_entries:**
```sql
CREATE UNIQUE INDEX unique_dre_entry 
ON dre_entries (company_cnpj, date, account, natureza);
```
- Garante unicidade por empresa, data, conta e natureza
- Permite upsert via Edge Function

**dfc_entries:**
```sql
CREATE UNIQUE INDEX unique_dfc_entry 
ON dfc_entries (company_cnpj, date, kind, category, bank_account);
```
- Garante unicidade por empresa, data, tipo, categoria e conta banc√°ria
- **IMPORTANTE**: `bank_account` deve ser string vazia (`''`) quando NULL para constraint funcionar
- Permite upsert via Edge Function

**accounting_entries:**
- N√£o possui constraint √∫nica (permite m√∫ltiplos lan√ßamentos com mesmos dados)
- Usar `INSERT` direto (n√£o upsert)

---

## üìã FLUXO DE IMPORTA√á√ÉO VALIDADO

### Fluxo Completo F360

1. **Descoberta de Empresas** (Edge Function `f360-discover`)
   - Recebe token F360
   - Lista contas banc√°rias via `ListarContasBancarias`
   - Extrai CNPJs √∫nicos
   - Retorna modo (SINGLE/GROUP) e lista de CNPJs

2. **Sincroniza√ß√£o de Dados** (Edge Function `sync-f360`)
   - **SINGLE**: `POST /sync-f360` com `{ cnpj, dataInicio, dataFim }`
   - **GROUP**: `POST /sync-f360/group` com `{ token, expectedCnpjs, dataInicio, dataFim }`
   - Login F360 com retry (3 tentativas)
   - Gera relat√≥rio cont√°bil
   - Aguarda processamento (at√© 30 tentativas, 5s cada)
   - Processa e valida dados
   - Salva via upsert (DRE/DFC) ou insert (Accounting)
   - Registra log em `import_logs`

3. **Valida√ß√£o P√≥s-Importa√ß√£o** (Scripts de teste)
   - `test_data_integrity.mjs` - Valida totais DRE/DFC
   - `test_no_duplicates.mjs` - Verifica aus√™ncia de duplicatas
   - `test_consolidation.mjs` - Valida consolida√ß√£o de m√∫ltiplas empresas
   - `test_filter_consistency.mjs` - Verifica filtros por empresa/per√≠odo

### Checklist de Valida√ß√£o P√≥s-Importa√ß√£o

Ap√≥s cada importa√ß√£o, executar:
- [ ] `test_data_integrity.mjs` - Integridade de totais
- [ ] `test_no_duplicates.mjs` - Aus√™ncia de duplicatas
- [ ] Verificar `import_logs` para status e erros
- [ ] Validar contagem de registros por empresa
- [ ] Verificar se todas empresas esperadas t√™m dados

---

> **Nota**: Este √≠ndice deve ser atualizado ap√≥s mudan√ßas significativas no projeto. Manter formato compacto para economizar tokens.

