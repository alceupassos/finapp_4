# Cursor Rules - FinApp Dashboard

## Regras de Filtros e Contexto

### 1. SEMPRE Respeitar Filtros da P√°gina
- **CR√çTICO**: Todos os componentes, gr√°ficos, tabelas e fun√ß√µes devem SEMPRE respeitar os filtros selecionados pelo usu√°rio na p√°gina
- Filtros incluem: per√≠odo (Ano/M√™s), ano, trimestre, m√™s, categoria, conta banc√°ria, empresas selecionadas
- NUNCA ignorar ou sobrescrever filtros do usu√°rio
- Quando criar novos componentes, SEMPRE aceitar e aplicar filtros como props
- Quando buscar dados, SEMPRE usar os filtros fornecidos nas queries

### 2. Filtros Globais vs Locais
- Filtros globais v√™m de `App.tsx` (selectedCompanies, period, selectedMonth)
- Filtros locais v√™m de componentes espec√≠ficos (HorizontalFilters, etc)
- Componentes devem aceitar ambos e aplicar a interse√ß√£o dos filtros
- Prioridade: filtros locais espec√≠ficos > filtros globais

### 3. Bot√£o de Reset de Filtros
- Sempre incluir um bot√£o discreto para resetar filtros aos valores padr√£o
- Bot√£o deve ser vis√≠vel mas n√£o intrusivo (√≠cone pequeno, posi√ß√£o discreta)
- Reset deve voltar para: Ano atual, per√≠odo "Ano", todos os meses/trimestres/categorias

### 4. Empresas e Grupos
- NUNCA filtrar por "Grupo Volpe" ou qualquer grupo espec√≠fico hardcoded
- Usar apenas empresas associadas ao usu√°rio logado via `user_companies`
- N√£o assumir grupo empresarial espec√≠fico - usar dados do banco
- Remover todos os fallbacks hardcoded com "Grupo Volpe"

### 5. Dados e Queries
- Todas as queries devem usar filtros de per√≠odo, empresa e categoria quando aplic√°vel
- N√£o retornar dados fora do per√≠odo selecionado
- N√£o retornar dados de empresas n√£o selecionadas
- Consolidar dados apenas das empresas selecionadas

### 6. Componentes de Gr√°ficos
- Todos os gr√°ficos devem aceitar props de filtros (cnpj, year, month, etc)
- Aplicar filtros antes de renderizar dados
- Mostrar indicador visual quando filtros est√£o ativos
- Atualizar automaticamente quando filtros mudam

### 7. Performance
- Cachear dados apenas quando filtros s√£o os mesmos
- Invalidar cache quando filtros mudam
- N√£o fazer queries desnecess√°rias com filtros diferentes

## Exemplos de Implementa√ß√£o

### Componente com Filtros
```typescript
interface MyComponentProps {
  selectedCompanies: string[]
  selectedYear: string
  selectedMonth?: string
  // ... outros filtros
}

export function MyComponent({ selectedCompanies, selectedYear, selectedMonth }: MyComponentProps) {
  // SEMPRE usar os filtros fornecidos
  const data = useMemo(() => {
    return fetchData(selectedCompanies, selectedYear, selectedMonth)
  }, [selectedCompanies, selectedYear, selectedMonth])
  
  // ...
}
```

### Query com Filtros
```typescript
const query = {
  company_cnpj: `in.(${selectedCompanies.join(',')})`,
  year: `eq.${selectedYear}`,
  ...(selectedMonth && { month: `eq.${selectedMonth}` })
}
```

### Bot√£o Reset
```typescript
<button
  onClick={() => {
    onYearChange(new Date().getFullYear().toString())
    onMonthChange('')
    onQuarterChange('')
    onCategoryChange('')
  }}
  className="text-xs text-muted-foreground hover:text-foreground"
  title="Limpar filtros"
>
  <X className="w-3 h-3" />
</button>
```

---

# üìö √çNDICE INCREMENTAL DO PROJETO

> **Uso**: Consultar este √≠ndice antes de ler arquivos completos. Atualizar incrementalmente ap√≥s mudan√ßas significativas.

## üîç QUICK REFERENCE - Arquivos Principais

| Caminho | Fun√ß√£o | √öltima Atualiza√ß√£o |
|---------|--------|-------------------|
| `src/App.tsx` | Componente raiz, roteamento, filtros globais | 2025-01 |
| `src/components/ReportsPage.tsx` | P√°gina principal de relat√≥rios com sidebar | 2025-01 |
| `src/components/reports/ReportsSidebar.tsx` | Menu lateral retr√°til de se√ß√µes | 2025-01 |
| `src/components/reports/DRESection.tsx` | Se√ß√£o DRE com KPIs e gr√°ficos | 2025-01 |
| `src/components/reports/DFCSection.tsx` | Se√ß√£o DFC (fluxo de caixa) | 2025-01 |
| `src/components/reports/BanksSection.tsx` | Se√ß√£o de contas banc√°rias | 2025-01 |
| `src/components/reports/ReconciliationSection.tsx` | Concilia√ß√£o banc√°ria | 2025-01 |
| `src/services/f360Service.ts` | Cliente TypeScript API F360 | 2025-01 |
| `src/services/supabaseRest.ts` | Cliente REST Supabase, queries | 2025-01 |
| `src/services/auth.ts` | Autentica√ß√£o Supabase | 2025-01 |
| `scripts/import_volpe_f360.mjs` | Importa√ß√£o dados 13 empresas Volpe | 2025-01 |
| `scripts/register_volpe_companies.mjs` | Cadastro empresas no Supabase | 2025-01 |
| `supabase/migrations/create_f360_volpe_tables.sql` | Tabelas DRE/DFC/Bancos | 2025-01 |

## üîê CREDENCIAIS E CONFIGURA√á√ïES

### F360 Finan√ßas
- **Base URL**: `https://financas.f360.com.br`
- **Token Grupo Volpe**: `223b065a-1873-4cfe-a36b-f092c602a03e`
- **Login**: `volpe.matriz@ifinance.com.br`
- **Senha**: `v3T$cABl5.`
- **Endpoints principais**:
  - Login: `POST /PublicLoginAPI/DoLogin`
  - Plano Contas: `GET /PlanoDeContasPublicAPI/ListarPlanosContas`
  - Contas Banc√°rias: `GET /ContaBancariaPublicAPI/ListarContasBancarias`
  - Parcelas T√≠tulos: `GET /ParcelasDeTituloPublicAPI/ListarParcelasDeTitulos`
  - Relat√≥rios: `POST /PublicRelatorioAPI/GerarRelatorio`

### Supabase
- **Vari√°veis**: `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`, `SUPABASE_SERVICE_ROLE_KEY`
- **Tabelas principais**: `companies`, `dre_entries`, `dfc_entries`, `bank_accounts`, `bank_transactions`, `reconciliation_items`, `user_companies`, `accounting_entries`, `chart_of_accounts`

### Grupo Volpe - 13 Empresas
| CNPJ | Nome |
|------|------|
| 26888098000159 | VOLPE MATRIZ |
| 26888098000230 | VOLPE ZOIAO |
| 26888098000310 | VOLPE MAU√Å |
| 26888098000400 | VOLPE DIADEMA |
| 26888098000582 | VOLPE GRAJA√ö |
| 26888098000663 | VOLPE SANTO ANDR√â |
| 26888098000744 | VOLPE CAMPO LIMPO |
| 26888098000825 | VOLPE BRASIL√ÇNDIA |
| 26888098000906 | VOLPE PO√Å |
| 26888098001040 | VOLPE ITAIM |
| 26888098001120 | VOLPE PRAIA GRANDE |
| 26888098001201 | VOLPE ITANHA√âM |
| 26888098001392 | VOLPE S√ÉO MATHEUS |

## üèóÔ∏è ARQUITETURA

### Stack Principal
- **Frontend**: React 18 + TypeScript + Vite
- **UI**: TailwindCSS + Radix UI + Framer Motion
- **Gr√°ficos**: Recharts + Tremor
- **Backend**: Supabase (PostgreSQL + Auth + Storage)
- **Integra√ß√£o**: F360 API (REST + Webhooks)

### Padr√µes de C√≥digo
- **Componentes**: Functional Components com hooks
- **Estado**: useState/useEffect, Zustand para global
- **Queries**: Supabase REST API via `supabaseRest.ts`
- **Anima√ß√µes**: Framer Motion (entrada escalonada, hover effects)
- **Filtros**: Props drilling de App.tsx ‚Üí componentes filhos
- **Estilo**: Classes Tailwind + `card-premium` para cards

### Estrutura de Pastas
```
src/
‚îú‚îÄ‚îÄ components/        # Componentes React
‚îÇ   ‚îú‚îÄ‚îÄ reports/      # Se√ß√µes de relat√≥rios
‚îÇ   ‚îú‚îÄ‚îÄ charts/       # Gr√°ficos Recharts
‚îÇ   ‚îî‚îÄ‚îÄ ui/           # Componentes base Radix
‚îú‚îÄ‚îÄ services/         # Clientes API, l√≥gica de neg√≥cio
‚îú‚îÄ‚îÄ hooks/            # Custom hooks
‚îú‚îÄ‚îÄ types/            # TypeScript types
‚îî‚îÄ‚îÄ lib/              # Utilit√°rios

scripts/              # Scripts Node.js (importa√ß√£o, migra√ß√µes)
supabase/migrations/  # Migra√ß√µes SQL
```

## üõ†Ô∏è COMANDOS √öTEIS

### Desenvolvimento
```bash
npm run dev              # Iniciar dev server
npm run build            # Build produ√ß√£o
npm run lint             # Verificar TypeScript
npm run preview          # Preview build
```

### Importa√ß√£o de Dados
```bash
# Importar 13 empresas Volpe do F360
node scripts/import_volpe_f360.mjs

# Cadastrar empresas no Supabase
node scripts/register_volpe_companies.mjs
```

### Supabase
```bash
# Aplicar migra√ß√µes
supabase migration up

# Configurar secrets
npm run supabase:secrets
```

## üìù CHANGELOG

### 2025-01-XX - Importa√ß√£o F360 Grupo Volpe + √Årea Relat√≥rios
- ‚úÖ Criadas tabelas: `dre_entries`, `dfc_entries`, `bank_accounts`, `bank_transactions`, `reconciliation_items`
- ‚úÖ Cadastradas 13 empresas Volpe no Supabase
- ‚úÖ Criado `f360Service.ts` - cliente TypeScript F360
- ‚úÖ Criado `import_volpe_f360.mjs` - script importa√ß√£o
- ‚úÖ Refatorado `ReportsPage.tsx` com sidebar retr√°til
- ‚úÖ Criadas se√ß√µes: DRE, DFC, Bancos, Concilia√ß√£o
- ‚úÖ Componentes: `AnimatedReportCard`, `DREWaterfallChart`, `CashflowSankeyChart`
- ‚úÖ Anima√ß√µes Framer Motion em todos componentes

### Hist√≥rico Anterior
- Sistema base com dashboard, an√°lises, not√≠cias
- Integra√ß√£o Supabase para dados financeiros
- Componentes de gr√°ficos e KPIs
- Autentica√ß√£o e controle de acesso

## ‚ö†Ô∏è TODOs / PEND√äNCIAS

### Alta Prioridade
- [ ] Implementar busca real de dados DFC do Supabase (atualmente mockado)
- [ ] Implementar busca real de contas banc√°rias e transa√ß√µes
- [ ] Completar implementa√ß√£o Sankey chart (requer d3-sankey)
- [ ] Adicionar m√©todo `getDFC()` no `supabaseRest.ts`
- [ ] Testar importa√ß√£o completa F360 com dados reais

### M√©dia Prioridade
- [ ] Implementar match autom√°tico de concilia√ß√£o banc√°ria
- [ ] Adicionar exporta√ß√£o Excel para DRE/DFC
- [ ] Criar se√ß√£o "Plano de Contas" completa
- [ ] Adicionar filtros avan√ßados por categoria/centro de custo
- [ ] Implementar cache de queries para performance

### Baixa Prioridade
- [ ] Adicionar testes unit√°rios
- [ ] Documenta√ß√£o de API
- [ ] Otimiza√ß√£o de bundle size
- [ ] PWA support

## üîë KEYWORDS PARA BUSCA R√ÅPIDA

**F360**: `f360Service.ts`, `import_volpe_f360.mjs`, `F360Service`
**DRE**: `DRESection.tsx`, `dre_entries`, `DREPivotTable.tsx`
**DFC**: `DFCSection.tsx`, `dfc_entries`, `DFCPivotTable.tsx`
**Bancos**: `BanksSection.tsx`, `bank_accounts`, `bank_transactions`
**Concilia√ß√£o**: `ReconciliationSection.tsx`, `reconciliation_items`
**Filtros**: `HorizontalFilters.tsx`, `App.tsx` (selectedCompanies, period)
**Gr√°ficos**: `charts/`, `Recharts`, `DREWaterfallChart.tsx`
**Anima√ß√µes**: `Framer Motion`, `AnimatedReportCard.tsx`
**Supabase**: `supabaseRest.ts`, `auth.ts`, migrations em `supabase/migrations/`

---

> **Nota**: Este √≠ndice deve ser atualizado ap√≥s mudan√ßas significativas no projeto. Manter formato compacto para economizar tokens.

